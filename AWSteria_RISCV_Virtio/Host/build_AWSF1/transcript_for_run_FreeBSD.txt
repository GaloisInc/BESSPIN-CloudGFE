# Annotated transcript of booting and running FreeBSD on AWSteria:Flute:Virtio on AWS F1
# COMMENT annotation lines below point out highlights, including use of virtio
# networking and block device.

# ================================================================
# COMMENT: Load AFI into FPGA

--20:45:24--ip-10-10-37-101: ~/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/App_RISCV_Virtio/Host/build_AWSF1
$ sudo fpga-load-local-image -S 0 -I "agfi-0fe4c00a6a1530545"
AFI          0       agfi-0fe4c00a6a1530545  loaded            0        ok               0       0x04261818
AFIDEVICE    0       0x1d0f      0xf001      0000:00:1d.0
INFO: Loaded AFI "ASWteria RISCV 125 MHz w. Debug Module"

# ================================================================
# COMMENT: Obtain a clean copy of a .img file that is formatted as a
# block device, that will serve as virtio block device

$ rsync  /home/centos/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/Tests/cheribsd-riscv64.img  cheribsd-riscv64.img

# ================================================================
# COMMENT: Start AWSteria:Flute:Virtio, providing it a memhex32 file
# for bbl boot rom and FreeBSD image, and file for Virtio block device
# RISC-V console messages from FreeBSD follow on subsequent lines

$ sudo /home/centos/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/App_RISCV_Virtio/Host/build_AWSF1/exe_Host_AWSF1 --memhex32 /home/centos/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/Tests/bbl_and_FreeBSD.FETT-NODEBUG.host.memhex32 --blockdev cheribsd-riscv64.img
load_mem_hex32_using_DMA: downloading to AWS DDR4
bbl loader
---<<BOOT>>---
KDB: debugger backends: ddb
KDB: current backend: ddb
Physical memory chunk(s):
  0xc0000000 - 0xffffffff,  1024 MB ( 262144 pages)
Excluded memory regions:
  0xc0000000 - 0xc01fffff,     2 MB (    512 pages) NoAlloc NoDump
  0xc0200000 - 0xc0926fff,     7 MB (   1831 pages) NoAlloc 
Found 1 CPUs in the device tree
Copyright (c) 1992-2020 The FreeBSD Project.
Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
	The Regents of the University of California. All rights reserved.
FreeBSD is a registered trademark of The FreeBSD Foundation.
FreeBSD 13.0-CURRENT #4 r362121+89083b90c601-c327974(multicompat)-dirty: Thu Sep  3 15:52:05 BST 2020
    jrtc4@zeno.sec.cl.cam.ac.uk:/home/jrtc4/cheri/build/cheribsd-riscv64-build/home/jrtc4/cheri/cheribsd/riscv.riscv64/sys/FETT-NODEBUG riscv
clang version 11.0.0 (git@github.com:CTSRD-CHERI/llvm-project.git 61ef05e7b0781437373e58c74936422cb9da0a53)
Preloaded elf kernel "kernel" at 0xffffffc0007057a0.
SBI: Unknown (Legacy) Implementation
SBI Specification Version: 0.1
CPU(0): Unknown Implementer Unknown Processor
real memory  = 1073741824 (1024 MB)
Physical memory chunk(s):
0x00000000c0927000 - 0x00000000fe66efff, 1037336576 bytes (253256 pages)
avail memory = 1032081408 (984 MB)
No static device mappings.
random: no preloaded entropy cache
arc4random: WARNING: initial seeding bypassed the cryptographic random device because it was not yet seeded and the knob 'bypass_before_seeding' was enabled.
VIMAGE (virtualized network stack) enabled
hostuuid: using 00000000-0000-0000-0000-000000000000
ULE: setup cpu 0
random: entropy device external interface
mem: <memory>
crypto: <crypto core>
null: <full device, null device, zero device>
openfirm: <Open Firmware control device>
WARNING: Device "openfirm" is Giant locked and may be deleted before FreeBSD 13.0.
ofwbus0: <Open Firmware Device Tree>
simplebus0: <Flattened device tree simple bus> on ofwbus0
plic0: <RISC-V PLIC> mem 0xc000000-0xc3fffff irq 4,5 on simplebus0
timer0: <RISC-V Timer>
Timecounter "RISC-V Timecounter" frequency 125000000 Hz quality 1000
Event timer "RISC-V Eventtimer" frequency 125000000 Hz quality 1000
rcons0: <RISC-V console>
cpulist0: <Open Firmware CPU Group> on ofwbus0
cpu0: <Open Firmware CPU> on cpulist0
cpu0: Nominal frequency 125Mhz
riscv64_cpu0: register <0>
uart0: <8250 or 16450 or compatible> mem 0x62300000-0x62300fff irq 6 on simplebus0
uart0: console (115200,n,8,1)
uart0: fast interrupt
uart0: PPS capture mode: DCD

# COMMENT: FreeBSD is discovering Virtio devices in the following lines

virtio_mmio0: <VirtIO MMIO adapter> mem 0x40000000-0x40000fff irq 0 on ofwbus0
vtblk0: <VirtIO Block Adapter> on virtio_mmio0
virtio_mmio0: host features: 0x100000000 <Version1>
virtio_mmio0: negotiated features: 0
virtio_mmio0: virtqueue 0 (vtblk0 request) requested indirect descriptors but not negotiated
vtblk0: vtblk_poll_request: IO error: 5
vtblk0: error getting device identifier: 5
vtblk0: 4784MB (9797637 512 byte sectors)
virtio_mmio1: <VirtIO MMIO adapter> mem 0x40001000-0x40001fff irq 1 on ofwbus0
vtnet0: <VirtIO Networking Adapter> on virtio_mmio1
virtio_mmio1: host features: 0x100000020 <Version1,MacAddress>
virtio_mmio1: negotiated features: 0x100000020 <Version1,MacAddress>
virtio_mmio1: virtqueue 0 (vtnet0-0 rx) requested indirect descriptors but not negotiated
virtio_mmio1: virtqueue 1 (vtnet0-0 tx) requested indirect descriptors but not negotiated
vtnet0: bpf attached
vtnet0: Ethernet address: 02:00:00:00:00:00
virtio_mmio2: <VirtIO MMIO adapter> mem 0x40002000-0x40002fff irq 2 on ofwbus0
vtrnd0: <VirtIO Entropy Adapter> on virtio_mmio2
virtio_mmio2: host features: 0x100000000 <Version1>
virtio_mmio2: negotiated features: 0
random: registering fast source VirtIO Entropy Adapter
virtio_mmio3: <VirtIO MMIO adapter> mem 0x40003000-0x40003fff irq 3 on ofwbus0
virtio_mmio3: Unsupported version: 0
device_attach: virtio_mmio3 attach returned 6
cryptosoft0: <software crypto>
crypto: assign cryptosoft0 driver id 0, flags 0x6000000
Device configuration finished.
procfs registered
Timecounters tick every 10.000 msec
lo0: bpf attached
vlan: initialized, using hash tables with chaining
tcp_init: net.inet.tcp.tcbhashsize auto tuned to 8192
IPsec: Initialized Security Association Processing.
GEOM: new disk vtbd0
Obsolete code will be removed soon: random(9) is the obsolete Park-Miller LCG from 1988
Trying to mount root from ufs:/dev/ufs/root []...
Warning: no time-of-day clock registered, system time will not be set accurately
start_init: trying /sbin/init
/etc/rc: WARNING: hostid: unable to figure out a UUID from DMI data, generating a new one
Setting hostuuid: 6b2082b3-edf3-11ea-92d0-4581708440d6.
Setting hostid: 0xd240ed20.
Starting file system checks:
/dev/ufs/root: FILE SYSTEM CLEAN; SKIPPING CHECKS
/dev/ufs/root: clean, 309020 free (4 frags, 38627 blocks, 0.0% fragmentation)
Mounting local filesystems:.
ELF ldconfig path: /lib /usr/lib /usr/lib/compat
random: unblocking device.
devmatch: Can't read linker hints file.
Setting hostname: qemu-cheri-jrtc4.
Setting up harvesting: PURE_VIRTIO,[UMA],[FS_ATIME],SWI,INTERRUPT,NET_NG,[NET_ETHER],NET_TUN,MOUSE,KEYBOARD,ATTACH,CACHED
Feeding entropy: .
lo0: link state changed to UP
vtnet0: link state changed to UP
Starting Network: lo0 vtnet0.
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> metric 0 mtu 16384
	options=680003<RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
	inet6 ::1 prefixlen 128
	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
	inet 127.0.0.1 netmask 0xff000000
	groups: lo
	nd6 options=21<PERFORMNUD,AUTO_LINKLOCAL>
vtnet0: flags=8963<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> metric 0 mtu 1500
	options=28<VLAN_MTU,JUMBO_MTU>
	ether 02:00:00:00:00:00
	media: Ethernet 10Gbase-T <full-duplex>
	status: active
	nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
Starting devd.
devmatch: Can't read linker hints file.
devmatch: Can't read linker hints file.
Starting dhclient.
DHCPDISCOVER on vtnet0 to 255.255.255.255 port 67 interval 8
DHCPOFFER from 10.0.2.2
DHCPREQUEST on vtnet0 to 255.255.255.255 port 67
DHCPACK from 10.0.2.2
bound to 10.0.2.15 -- renewal in 43200 seconds.
add host 127.0.0.1: gateway lo0 fib 0: route already in table
add host ::1: gateway lo0 fib 0: route already in table
add net fe80::: gateway ::1
add net ff02::: gateway ::1
add net ::ffff:0.0.0.0: gateway ::1
add net ::0.0.0.0: gateway ::1
Creating and/or trimming log files.
Starting syslogd.
No core dumps found.
NFS access cache time=60
Clearing /tmp (X related).
Updating motd:.
Mounting late filesystems:.
Updating /var/run/os-release done.
Performing sanity check on sshd configuration.
Starting sshd.
Starting background file system checks in 60 seconds.

# COMMENT: Finally, the FreeBSD banner and login prompt
# We log in as root and type a few shell commands (uname, ls)

Thu Sep  3 14:42:19 UTC 2020

FreeBSD/riscv (qemu-cheri-jrtc4) (ttyu0)

login: root
root
Sep  3 14:42:55 qemu-cheri-jrtc4 login[691]: ROOT LOGIN (root) ON ttyu0
FreeBSD 13.0-CURRENT (FETT-NODEBUG) #4 r362121+89083b90c601-c327974(multicompat)-dirty: Thu Sep  3 15:52:05 BST 2020

Welcome to CheriBSD!

CheriBSD extends FreeBSD to implement memory protection and software
compartmentalization features supported by the CHERI ISA.

CheriBSD source may be found at https://github.com/CTSRD-CHERI/cheribsd/

We provide support via mailing list
https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-lists.html.

Find out more about about CHERI at http://cheri-cpu.org/
7[r[6n8resizewin: timeout reading from terminal
root@qemu-cheri-jrtc4:~ # 

root@qemu-cheri-jrtc4:~ # uname -a
uname -a
FreeBSD qemu-cheri-jrtc4 13.0-CURRENT FreeBSD 13.0-CURRENT #4 r362121+89083b90c601-c327974(multicompat)-dirty: Thu Sep  3 15:52:05 BST 2020     jrtc4@zeno.sec.cl.cam.ac.uk:/home/jrtc4/cheri/build/cheribsd-riscv64-build/home/jrtc4/cheri/cheribsd/riscv.riscv64/sys/FETT-NODEBUG  riscv
root@qemu-cheri-jrtc4:~ # ls
ls
.bash_profile           .k5login                .shrc
.bashrc                 .login                  .ssh
.cshrc                  .profile                make-purecap-chroot

# ================================================================
# COMMENT: Demonstrate networking by ssh'ing to a remote machine on the internet

root@qemu-cheri-jrtc4:~ # ssh nikhil@login.bluespec.com
ssh nikhil@login.bluespec.com
The authenticity of host 'login.bluespec.com (72.74.208.5)' can't be established.
ECDSA key fingerprint is SHA256:zzYHjw7fK18aEwsPByJI5gUB6IAWlBb80peZGm5tKD4.
No matching host key fingerprint found in DNS.
Are you sure you want to continue connecting (yes/no)? yes
yes
Warning: Permanently added 'login.bluespec.com' (ECDSA) to the list of known hosts.
nikhil@login.bluespec.com's password: 

# ----------------------------------------------------------------
# COMMENT: And we are now at the shell of the remote machine
# We compute a reference sha256 of a 7-megabyte file that we're soon
# going to 'scp' back to FreeBSD

Linux proxy 4.19.0-17-amd64 #1 SMP Debian 4.19.194-1 (2021-06-10) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Sep  8 19:07:49 2021 from 34.222.151.101
  PATH prefixed with    ~/bin
Setting up Bluespec
BLUESPEC_LICENSE_FILE =  @license.bluespec.com
  BLUESPEC_HOME =  /export/home/nikhil/NoBak/Bluespec-2018.10.beta1
  BLUESPECDIR   =  /export/home/nikhil/NoBak/Bluespec-2018.10.beta1/lib
  PATH prefixed with /export/home/nikhil/NoBak/Bluespec-2018.10.beta1/bin
--20:49:04--proxy: ~
$ uname -a
uname -a
Linux proxy 4.19.0-17-amd64 #1 SMP Debian 4.19.194-1 (2021-06-10) x86_64 GNU/Linux
--20:49:08--proxy: ~
$ ls -als data*
ls -als data*
159592 -rw-r--r-- 1 nikhil nikhil 163416078 Jun 18 13:45 data163M.txt
  5120 -rw-r--r-- 1 nikhil nikhil   5242880 Jun 23 19:47 data163M_B.txt
     4 -rw-r--r-- 1 nikhil nikhil       648 Sep 13  2020 data1K.txt
   244 -rw-r--r-- 1 nikhil nikhil    249228 Jun 17  2019 data249K.txt
 31396 -rw-r--r-- 1 nikhil nikhil  32149504 Jun 18 12:51 data32M.txt
  7028 -rw-r--r-- 1 nikhil nikhil   7189778 Jun  6 15:29 data7M.txt
--20:49:15--proxy: ~
$ exit
exit
logout
Connection to login.bluespec.com closed.

--20:51:56--proxy: ~
$ sha256sum data7M.txt
sha256sum data7M.txt
26da2fded035178c43ff848f72abe71d4f39256df8d69442d92029c766293831  data7M.txt

# ----------------------------------------------------------------
# COMMENT: and we have closed the connection and are back at FreeBSD's prompt
# We 'scp' a 7 megabyte file from the remote machine back to our local
# (FreeBSD)'s block storage device.

root@qemu-cheri-jrtc4:~ # scp nikhil@login.bluespec.com:~/data7M.txt .
scp nikhil@login.bluespec.com:~/data7M.txt .
nikhil@login.bluespec.com's password: 
data7M.txt                                    100% 7021KB 123.0KB/s   00:57    

# ----------------------------------------------------------------
# COMMENT: we verify that its sha256 sum is same as it was on the remote machine

root@qemu-cheri-jrtc4:~ # sha256 data7M.txt
sha256 data7M.txt
SHA256 (data7M.txt) = 26da2fded035178c43ff848f72abe71d4f39256df8d69442d92029c766293831

# ----------------------------------------------------------------
# COMMENT: we verify that its sha256 sum is same as it was on the remote machine

# ================================================================
# COMMENT: we verify correct persistence of the new file by shutting
# down FreeBSD and restarting FreeBSD with the same block device; then
# check the new file is still present and has the right sha256 sum.
# We have snipped most of the boot-time console messages (same as
# previous boot above).

root@qemu-cheri-jrtc4:~ # shutdown -h now
shutdown -h now
Shutdown NOW!
shutdown: [pid 707]
root@qemu-cheri-jrtc4:~ #                                                                                
*** FINAL System shutdown message from root@qemu-cheri-jrtc4 ***             

System going down IMMEDIATELY                                                  

                                                                               
Sep  3 14:47:18 qemu-cheri-jrtc4 shutdown[707]: halt by root: 

System shutdown time has arrived
Stopping sshd.
Stopping devd.
Writing entropy file: .
Writing early boot entropy file: .
Terminated
.
Sep  3 14:47:50 qemu-cheri-jrtc4 syslogd: exiting on signal 15
Waiting (max 60 seconds) for system process `vnlru' to stop... done
Waiting (max 60 seconds) for system process `syncer' to stop... 
Syncing disks, vnodes remaining... 2 1 0 done
Waiting (max 60 seconds) for system thread `bufdaemon' to stop... done
Waiting (max 60 seconds) for system thread `bufspacedaemon-0' to stop... done
All buffers synced.
Swap device [file] removed.
Uptime: 7m31s

The operating system has halted.
Please press any key to reboot.

  C-c C-cmake: *** [test_Flute_Virtio] Interrupt

# ----------------------------------------------------------------
# COMMENT: reload FPGA and reboot with same block device file

$ sudo fpga-load-local-image -S 0 -I "agfi-0fe4c00a6a1530545"
AFI          0       agfi-0fe4c00a6a1530545  loaded            0        ok               0       0x04261818
AFIDEVICE    0       0x1d0f      0xf001      0000:00:1d.0

$ sudo /home/centos/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/App_RISCV_Virtio/Host/build_AWSF1/exe_Host_AWSF1 --memhex32 /home/centos/git_clones/AWS/BESSPIN-CloudGFE_rsn2/AWSteria_vanilla/Tests/bbl_and_FreeBSD.FETT-NODEBUG.host.memhex32 --blockdev cheribsd-riscv64.img
load_mem_hex32_using_DMA: downloading to AWS DDR4
bbl loader
---<<BOOT>>---
KDB: debugger backends: ddb
KDB: current backend: ddb
Physical memory chunk(s):
  0xc0000000 - 0xffffffff,  1024 MB ( 262144 pages)
...
... <snipped boot-time console messages until login prompt> ...
...

Thu Sep  3 14:49:39 UTC 2020

FreeBSD/riscv (qemu-cheri-jrtc4) (ttyu0)

login: root
root
Sep  3 14:50:11 qemu-cheri-jrtc4 login[663]: ROOT LOGIN (root) ON ttyu0
Last login: Thu Sep  3 14:42:55 on ttyu0
FreeBSD 13.0-CURRENT (FETT-NODEBUG) #4 r362121+89083b90c601-c327974(multicompat)-dirty: Thu Sep  3 15:52:05 BST 2020

Welcome to CheriBSD!

CheriBSD extends FreeBSD to implement memory protection and software
compartmentalization features supported by the CHERI ISA.

CheriBSD source may be found at https://github.com/CTSRD-CHERI/cheribsd/

We provide support via mailing list
https://www.cl.cam.ac.uk/research/security/ctsrd/cheri/cheri-lists.html.

Find out more about about CHERI at http://cheri-cpu.org/
7[r[6n8resizewin: timeout reading from terminal

# ----------------------------------------------------------------
# COMMENT: Check that our new 'data7M.txt' file exists and has the
# right sha256 sum

root@qemu-cheri-jrtc4:~ # ls
ls
.bash_profile           .login                  data7M.txt
.bashrc                 .profile                make-purecap-chroot
.cshrc                  .shrc
.k5login                .ssh
root@qemu-cheri-jrtc4:~ # sha256 data7M.txt
sha256 data7M.txt
SHA256 (data7M.txt) = 26da2fded035178c43ff848f72abe71d4f39256df8d69442d92029c766293831
